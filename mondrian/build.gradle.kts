//import org.javacc.plugin.gradle.javacc.CompileJavaccTask

/*
* This file was generated by the Gradle 'init' task.
*/

plugins {
    id("java")
    id("java-library")
    //id("org.javacc.javacc") version "3.0.2"
    //id("com.dorongold.task-tree") version "2.1.1"
}

tasks.register("prepareKotlinBuildScriptModel") {}
java.sourceCompatibility = JavaVersion.VERSION_17
java.targetCompatibility = JavaVersion.VERSION_17


sourceSets {
    create("generateProperties") {
        java {
            srcDir("$projectDir/src/main/java/mondrian/util")
            include("PropertyUtil.java")
            compileClasspath += sourceSets["main"].compileClasspath
        }
    }

    create("generateResources") {
        java {
            srcDir("$projectDir/src/main/java/mondrian/olap")
            include("MondrianException.java", "ResultLimitExceededException.java", "InvalidHierarchyException.java", "ResourceLimitExceededException.java", "NativeEvaluationUnsupportedException.java", "QueryCanceledException.java", "QueryTimeoutException.java")
            compileClasspath += sourceSets["main"].compileClasspath
        }
    }

    create("compiledGeneratedResources") {
        java {
            srcDir("$projectDir/src/generated/java/mondrian/resource")
            compileClasspath += sourceSets["main"].compileClasspath
        }
    }

    main {
        java {
            srcDirs("src/generated/java")
            srcDirs("src/main/java")
            compileClasspath += sourceSets["generateProperties"].output
            compileClasspath += sourceSets["generateResources"].output
            compileClasspath += sourceSets["compiledGeneratedResources"].output
        }
    }
}

tasks {
/*    register("generateProperties", JavaCompile::class) {
        //source = fileTree("$projectDir/src/main/java/mondrian/util/PropertyUtil.java")
    }

    register("generateResources", JavaCompile::class) {
        //source = fileTree(listOf("MondrianException.java", "ResultLimitExceededException.java", "InvalidHierarchyException.java", "ResourceLimitExceededException.java", "NativeEvaluationUnsupportedException.java", "QueryCanceledException.java", "QueryTimeoutException.java").map { "$projectDir/src/main/java/mondrian/olap/$it" })
    }

    register("compiledGeneratedResources", JavaCompile::class) {
        //source = fileTree("$projectDir/src/generated/java/mondrian/resource")
    }*/

    register("ccParser", JavaExec::class) {
        group = "build"
        description = "Javacc compilation of Mondrian MDX grammar"
        mainClass.set("javacc")
        doFirst {
            val javaCCJar = javaccparsergen.resolvedConfiguration.resolvedArtifacts.single { it.extension == "jar" }.file.absolutePath
            classpath = fileTree(javaCCJar)
            args = listOf("-OUTPUT_DIRECTORY=${projectDir}/src/main/java/mondrian/parser", "${projectDir}/src/main/java/mondrian/parser/MdxParser.jj")
        }
        dependsOn(javaccparsergen)
    }

    register("generateMondrianProperties", JavaExec::class) {
        group = "build"
        description = "Mondrian properties class"
        mainClass.set("mondrian.util.PropertyUtil")
        classpath = sourceSets["generateProperties"].runtimeClasspath
        args = listOf("src/main/java/mondrian/olap", "src/generated/java/mondrian/olap")
        ///dependsOn(project.tasks.getByName("generateProperties"))
    }

    register("generateMondrianResources") {
        group = "build"
        dependsOn(resgen, getByName("compileGeneratePropertiesJava"), getByName("compileGenerateResourcesJava"))
        doLast {
            var resGenClassPath = project(":eigenbase-resgen").sourceSets.getByName("main").output.classesDirs.asPath
            resGenClassPath += ";" + configurations.getByName("compileClasspath").asPath
            ant.withGroovyBuilder {
                "taskdef"("name" to "resgen", "classname" to "org.eigenbase.resgen.ResourceGenTask", "classpath" to resGenClassPath)
                "resgen"("srcdir" to "src/main/java", "destdir" to "src/generated/java", "resdir" to "src/generated/resources", "style" to "functor", "locales" to "en_US") {
                    "include"("name" to "mondrian/resource/MondrianResource.xml")
                }
            }
        }
    }

    register("XOMGen") {
        group = "build"
        dependsOn(xomgen)
        doLast {
            val xomGenClassPath = project(":eigenbase-xom").sourceSets.getByName("main").output.classesDirs.asPath
            project.file("src/generated/java").mkdirs()
            ant.withGroovyBuilder {
                "taskdef"("name" to "xomgen",
                        "classname" to "org.eigenbase.xom.XOMGenTask",
                        "classpath" to xomGenClassPath)
                "xomgen"("model" to "src/main/java/mondrian/olap/Mondrian.xml",
                        "destdir" to "src/generated/java",
                        "classname" to "mondrian.olap.MondrianDef",
                        "dtdname" to "mondrian.dtd")
                "xomgen"("model" to "src/main/resources/DefaultRulesSchema.xml",
                        "destdir" to "src/generated/java",
                        "classname" to "mondrian.rolap.aggmatcher.DefaultDef",
                        "dtdname" to "aggregates.dtd")
                "xomgen"("model" to "src/main/java/mondrian/xmla/DataSourcesConfig.xml",
                        "destdir" to "src/generated/java",
                        "classname" to "mondrian.xmla.DataSourcesConfig",
                        "dtdname" to "datasourcesconfig.dtd")
            }
        }
    }

    register("parserCUP") {
        group = "build"
        dependsOn(parsergen)
        doLast {
            ant.withGroovyBuilder {
                val cupParserClassPath = files("../javacup/build/libs/javacup-all.jar").asPath
                "taskdef"("name" to "javacup",
                        "classname" to "java_cup.anttask.CUPTask",
                        "classpath" to cupParserClassPath
                )
                "javacup"("srcfile" to "$projectDir/src/main/java/mondrian/olap/Parser.cup",
                        "destdir" to "$projectDir/src/main/java/mondrian/olap/",
                        "package" to "mondrian.olap",
                        "parser" to "Parser",
                        "symbols" to "ParserSym",
                        "expect" to "63",
                        "interface" to "true")

            }
        }
    }
}

val resgen = configurations.create("resgen")
val xomgen = configurations.create("xomgen")
val parsergen = configurations.create("parsergen")
val javaccparsergen = configurations.create("javaccparsergen")

dependencies {
    api(libs.xml.apis.xml.apis)
    api(libs.commons.collections.commons.collections)
    api(libs.commons.dbcp.commons.dbcp)
    api(libs.commons.lang.commons.lang)
    api(libs.commons.io.commons.io)
    api(libs.commons.logging.commons.logging)
    api(libs.com.google.guava.guava)
    api(libs.org.apache.logging.log4j.log4j.core)
    api(libs.commons.math.commons.math)
    api(libs.commons.pool.commons.pool)
    api(libs.org.apache.commons.commons.vfs2)
    api(libs.org.dom4j.dom4j)
    api(libs.javax.validation.validation.api)
    api(project(":eigenbase-xom"))
    compileOnly(project(":eigenbase-properties"))
    compileOnly(project(":eigenbase-resgen"))
    resgen(project(":eigenbase-resgen"))
    xomgen(project(":eigenbase-xom"))
    api(libs.org.olap4j.olap4j)
    //api(libs.org.olap4j.olap4j.xmla)
    api(libs.xerces.xercesimpl)
    api(libs.javax.servlet.servlet.api)
    api(libs.javax.servlet.jsp.api)
    //api(libs.javacup.javacup)
    api(project(":javacup", configuration = "shadow"))
    parsergen(project(":javacup", configuration = "shadow"))
    api(libs.net.java.dev.javacc.javacc)
    javaccparsergen(libs.net.java.dev.javacc.javacc)
    testImplementation(libs.org.olap4j.olap4j.tck)
    testImplementation(libs.xmlunit.xmlunit)
    testImplementation(libs.org.mockito.mockito.all)
    testImplementation(libs.mysql.mysql.connector.java)
}

tasks.getByName("compileGeneratePropertiesJava") {
    dependsOn(project(":javacup").getTasksByName("shadowJar", false))
}

/*tasks.getByName("generateProperties") {
    dependsOn(project(":javacup").getTasksByName("shadowJar", false))
}*/


tasks.getByName("compileGenerateResourcesJava") {
    dependsOn(project(":javacup").getTasksByName("shadowJar", false))
}


/*tasks.getByName("compiledGeneratedResources") {
    dependsOn(project(":javacup").getTasksByName("shadowJar", false))
}*/

tasks.getByName("ccParser") {
    dependsOn(tasks.getByName("generateMondrianProperties"), tasks.getByName("generateMondrianResources"), tasks.getByName("parserCUP"), tasks.getByName("XOMGen"))
}

tasks.getByName("classes") {
    dependsOn(tasks.getByName("ccParser"))
}

tasks.getByName("clean") {
    delete("$projectDir/src/generated")
}